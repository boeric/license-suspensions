<!doctype html>
<html lang="en">

<!-- Author: Bo Ericsson, Email: bo@boe.net -->
<head>
  <title>License Suspensions</title>
  <meta charset="UTF-8">
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <style>
    body {
      margin: 0px;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
    p, a {
      font-size: 12px;
      line-height: 12px;
      margin: 0px
      margin-bottom: 10px;
    }
    a {
      margin-left: 10px;
    }
    h4 {
      margin-top: 10px;
      margin-bottom: 5px;
    }
    label {
      font-size: 12px;
    }
    #overlay {
      padding: 5px;
      position: absolute;
      min-width: 200px;
      max-width: 400px;
      top: 10px;
      left: 10px;
      border: 2px solid #D6D6D6;
      border-radius: 5px;
      background-color: white;
      opacity: 0.8;
      display: none;
      z-index: 10000;
    }
    #overlay p {
      margin: 5px;
    }
    #controls {
      padding1: 5px;
      margin-bottom: 15px;
    }
    #controls p {
      margin: 5px;
      margin-left: 0px;
    }
    #logoDiv {
      position: absolute;
      top: 20px;
      left: 20px;
    }
    #main {
      position: absolute;
      display: none;
      top: 10px;
      left: 20px;
      opacity: 0.85;
      background-color: white;
      border-radius: 5px;
      padding-left: 20px;
      padding-right: 20px;
      padding-bottom: 20px;
      z-index: 10000;
      width: 220px;
      border: 2px solid #D6D6D6;
    }
    ul {
      font-size: 12px;
      padding-left: 15px;
      margin-top: 5px;
      margin-bottom: 5px;
    }
    li {
      font-style: italic;
    }
    #howToUse:hover {
      color: red;
      cursor: pointer;
    }
    #sourcesTitle:hover {
      color: red;
      cursor: pointer;
    }
    #sources li {
      margin-top: 5px;
    }
    #map, #map2 { 
      position: absolute; 
      top: 0px; 
      bottom: 0px; 
      width: 100%; 
      border: 1px solid black;
    }
    #map2 {
      /*background-color: lightgray;*/
      right: 0px;
    }
    #divider {
      background-color: gray;
      width: 8px;
    }
    .header {
      display: block;
      color: Black;
      text-align: center;
      margin-top: 7px;
      text-shadow: 0px 0px 10px #fff;
    }
    .headerBox {
      position: absolute;
      top: 10px;
      left: 0;
      right: 0;
      margin: 0 auto;
      width: 250px;
      height: 35px;
      background-color: rgba(255, 255, 255, 0.85);
      border-radius: 5px;
      border: 2px solid #D6D6D6;
    }
    .dataSelect {
      position: absolute;
      bottom: 25px;
      /*left: 20px;*/
      /*margin: 0 auto;*/
      width: 210px;
      /*height: 280px;*/
      background-color: rgba(255, 255, 255, 0.85);
      border: 2px solid #D6D6D6;
      border-radius: 5px;
      padding: 10px 15px;
      display: none;
    }
    .dataSelect label {
      font-weight: bold;
    }
    .dataSelect select {
      margin-top: 8px;
      width: 200px;
    }
    .legendBox {
      position: absolute;
      bottom: 200px;
      right: 20px;
      /*margin: 0 auto;*/
      width: 80px;
      height: 400px;
      background-color: rgba(255, 255, 255, 0.85);
      border: 1px solid gray;
      border-radius: 5px;
      padding: 10px 15px;      
    }
    #loader {
      position: absolute; 
      top: 180px;
      left: 10px;
      width: 300px;
      height: 17px;
      padding: 10px;
      background: rgba(255, 255, 255, 1);
      transition: background 1s ease-out;
      -webkit-transition: background 1s ease-out;
      border1: 1px solid red;
    }
    #loader.done {
      background: rgba(255, 255, 255, 0);
    }
    #loader.hide {
      display: none;
    }
    #loader .message {
      position: absolute;
      font-size: 13px;
    }
    .legend {
      position: absolute;
      bottom: 25px;
      right: 20px;
      /*margin: 0 auto;*/
      width: 128px;
      background-color: rgba(255, 255, 255, 0.35);
      border: 2px solid #D6D6D6;
      border-radius: 5px;
      display: none;
    }
    .legend label {
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="container">
  <div id="map"></div>
  <div id="divider"></div>
  <div id="map2"></div>
</div>

<div style="position: relative; display: block">
  <div id="logoDiv" style="border1: 1px solid black">
    <div style="border1: 1px solid blue">
      <a href="http://www.ebclc.org" style="margin-left: 0px"><img src="BOTRCA Logo.png" style="width: 150px"></a>
    </div>
  </div>

  <div id="loader" style="border1: 1px solid red">
    <span id="message" class="message">Loading...</span>
    <div>
      <!--<img src="orange_spinner.gif" style="width: 60px">-->
    </div>
  </div>

  <div id="main">
    <h4 style="margin-bottom: 0px">Driver License Suspensions in California by Zip Code</h4>
    <p style="margin-top: 10px; font-weight: bold">Due to "Failure to Pay" or "Failure to Appear"</p>
    <div id="controls">
      <p>&nbsp;<p>&nbsp;<p>&nbsp;<p>&nbsp;<p>&nbsp;<p>&nbsp;<p>&nbsp;
    </div>

    <p style="margin-top: 10px; margin-bottom: 0px; font-weight: bold">Map tilt</p>
    <input id="tiltSlider" style="width: 100%" type="range" min="0" max="60" value="0" step="1">

    <p id="howToUse" style="margin-top: 10px; margin-bottom: 0px; font-weight: bold">How to use...</p>
    <ul id="instructions" style="display: none">
      <li>Move the mouse to see the specifics for the zip code</li>
      <li>The zip code boundaries are shown for each county</li>
      <li>The darker the zip code areas, the higher suspension rate</li>
      <li>Zoom in/out by rolling the mouse wheel, or by using the plus/minus buttons</li>
      <li>Pan around the map by dragging the mouse</li>
      <li>To tilt the map, use the slider above</li>
      <li>Rotate the map, drag the compass icon in upper right</li>
      <li>To reset the rotation, click the compass icon</li>
    </ul>

    <p id="sourcesTitle" style="margin-top: 10px; margin-bottom: 0px; font-weight: bold">About...</p>
    <ul id="sources" style="display: none">
      <li>
        Sources: CA DMV (license suspension data); US Census 2014 ACS (demographic data)
      </li>
      <li>
        Released April 2016 in conjunction with the Back on the Road CA coalition's Stopped, Fined, Arrested report. More information at <a href="http://www.ebclc.org/backontheroad" target="_blank" style="margin-left: 0px">www.ebclc.org/backontheroad</a>
      </li>
      <li>
        Interactive map engineering: <br>Bo Ericsson (bo@boe.net,<br><a href="https://github.com/boeric" target="_blank" style="margin-left: 0px">github.com/boeric</a>)
      </li>
    </ul>

  </div>
</div>

<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.11.4/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.11.4/mapbox-gl.css' rel='stylesheet' />
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<!--<script src="../_lib/d3.min.js" charset="utf-8" type="text/JavaScript"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.js" type="text/JavaScript"></script>
<!--<script src="../_lib/topojson.min.js" charset="utf-8" type="text/JavaScript"></script>-->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-72836906-3', 'auto');
  ga('send', 'pageview');
</script>


<script>
"use strict";

var dataSet = window.location.search.indexOf("dataFile=2015") != -1 ? "old" : "new",
    zipData = "cazipgeo.txt",
    suspData = dataSet == "old" ? "suspensions.txt" : "suspensions2016.txt",
    countyTopo = "county4.json",
    zipTopo = "ziptopo6.json",
    povDist,
    counties,
    zipcodes,
    data,
    zipGeo,
    countyZips,
    zipData,
    map,
    bins = 10,
    currGamma = 0.15,
    legendElemWidth = 35,
    legendElemHeight = 18, //13,
    legendSvgHeight = bins * legendElemHeight + 20,
    legendSvgWidth = 128,
    legendMarginLeft = 47,
    legendMarginTop = 10,
    fmt = d3.format(".0f"),
    fmt1 = d3.format(".1f"),
    fmtP = d3.format(",.2p"),
    targets = [
      { name: "SF Bay Area", location: [-122.35, 37.78], zoom: 10.0, bearing: 0, speed: 1, curve: 1 },
      { name: "Central LA", location: [-118.36, 33.92], zoom: 9.9, bearing: 0, speed: 1, curve: 1 },
      { name: "Sacramento", location: [-121.50, 38.53], zoom: 9.9, bearing: 0, speed: 1, curve: 1 },
      { name: "San Diego", location: [-117.16, 32.72], zoom: 10.4, bearing: 0, speed: 1, curve: 1 }
    ],
    loader = document.getElementById('loader');

loader.className = '';

window.onload = function() { start(); }
window.onresize = function() { setWindowSize() }


function setWindowSize() {
  var width = (window.innerWidth - 6) / 2;
  d3.select("#map").style("width", width + "px")
  d3.select("#map2").style("width", width + "px")

  setOverlayPos();
}
setWindowSize();


function setOverlayPos() {
  var main = d3.select("#main");
  var height = main.node().offsetHeight;
  var windowHeight = window.innerHeight;

  main.style("top", function(d) {
    return Math.max(10, window.innerHeight - height - 25) + "px"
  })    
}
setOverlayPos();


function start() {

  // load zip code data 
  d3.tsv(zipData, function(_) {
    zipGeo = _;

    // create object for quick lookup of a county's zip codes (used by code that dynamically injects zip code geometry)
    countyZips = {};
    zipGeo.forEach(function(d) {
      var key = d.County.trim(); 
      if (countyZips[key] == undefined) countyZips[key] = [];
      countyZips[key].push(+d.ZipCode)
    })

    // create data structure used to merge zip code and suspension data
    var obj = {};
    zipGeo.forEach(function(d) {
      var key = d.ZipCode.trim(); 
      obj[key] = d;
      delete obj[key].ZipCode;
    })
    zipGeo = obj; // redefine zipGeo from array to object
    //console.log("zipGeo", zipGeo)

    // load driver license suspension data
    d3.select("#message", "Loading driver license suspension data...")
    d3.tsv(suspData, function(suspensions) {
      console.log("loaded driver license suspension data...");

      // merge in the zip geo data and create main data structure
      data = suspensions.map(function(d, i, a) {
        var zipData = zipGeo[d.ZipCode];
        Object.keys(zipData).forEach(function(prop) { d[prop] = zipData[prop]; })
        return d;
      })

      // convert to numbers
      data.forEach(function(d) {
        var props = Object.keys(d);
        props.forEach(function(prop) { d[prop] = (isNaN(+d[prop])) ? d[prop] : +d[prop]; })
      })

      // sort data in ascending order (so highest suspension rates are drawn last and on top of the stack)
      data.sort(function(a, b) {
        return a.FTAFTPS100 - b.FTAFTPS100;
      })

      // create data structure for quick lookup (used by zip code geometry event handler)
      zipData = {};
      data.forEach(function(d) {
        zipData[d.ZipCode] = d;
      })
      //console.log("zipData", zipData)

      // load county geometry
      d3.select("#message").text("Loading county boundary data...");
      d3.json(countyTopo, function(error, county) {
        counties = topojson.feature(county, county.objects.CaliforniaCounty);
        console.log("loaded county info...");

        // load zip code geometry
        d3.select("#message").text("Loading zip code boundary data...")
        d3.json(zipTopo, function(error, zip) {
          zipcodes = topojson.feature(zip, zip.objects.zip);
          console.log("loaded zip code geo json file...")

          var caZipCodeMin = 90001;
          var caZipCodeMax = 96162;
          zipcodes.features = zipcodes.features.filter(function(item) {
            if (item.properties.zip >= caZipCodeMin && item.properties.zip <= caZipCodeMax) return true;
          })
          //console.log("number of zipcodes: ", zipcodes.features.length)
          //console.log("zipcodes", zipcodes);

          var nodataZipCodes = [];
          var undefCount = 0;
          zipcodes.features.forEach(function(d) {
            d.properties.zip = +d.properties.zip;
            var zipCode = d.properties.zip;

            if (zipData[zipCode] == undefined) {
              nodataZipCodes.push(zipCode);

              var zipGeoItem = zipGeo[zipCode];
              d.properties.noData = true;
            }
            else {
              d.properties.noData = false;
              d.properties.ZipCode = zipData[d.properties.zip].ZipCode;              
              d.properties.Places = zipData[d.properties.zip].Places;
              d.properties.City = zipData[d.properties.zip].City;
              d.properties.FTAFTPS100 = zipData[d.properties.zip].FTAFTPS100;
              d.properties.povrate = zipData[d.properties.zip].povrate;
              d.properties.Pop15Plus = zipData[d.properties.zip].Pop15Plus;
              d.properties.IncK = zipData[d.properties.zip].IncK;
              d.properties.Black = zipData[d.properties.zip].Black;
              d.properties.Hisp = zipData[d.properties.zip].Hisp;
              d.properties.WhiteNH = zipData[d.properties.zip].WhiteNH;
              d.properties.Asian = zipData[d.properties.zip].Asian;
            }

          })
          //console.log("nodataZipCodes: ", nodataZipCodes)
          console.log("Zip codes with no data: ", nodataZipCodes.length)

          zipcodes.features = zipcodes.features.filter(function(d) {
            if (d.properties.noData) return false;
            else return true;
          })
          //console.log("zipcodes.features.length: ", zipcodes.features)
          console.log("Zip codes with data: ", zipcodes.features.length);

          if (!mapboxgl.supported()) alert('Your browser does not support Mapbox GL');
          else mapBoxInit();
        })
      })
    })
  })
}


function mapBoxInit() {

  d3.select("#message").text("Loading vector maps...")

  // mapbox access token
  mapboxgl.accessToken = 'pk.eyJ1IjoiYm9lcmljIiwiYSI6IkZEU3BSTjQifQ.XDXwKy2vBdzFEjndnE4N7Q';

  // define map layers
  var layerStack0 =  [    
    {
      "id": "countiesArea",
      "interactive": true,
      "source": "counties",
      "type": "fill",
      "paint": {
        "fill-color": "white",
        "fill-opacity": 0.1//0.01
      }
    },
    {
      "id": "countiesLine",
      "source": "counties",
      "type": "line",
      "paint": {
        "line-color": "#999",
        "line-width": 1,
      }
    }
  ];

  var layerStack2 = [
    {
      "id": "zipcodesLine",
      "source": "zipcodes",
      "type": "line",
      "paint": {
        "line-color": "darkred",
        "line-width": 0 //0.5,
      }
    }
  ];

  // dataset dimensions
  //var bins = 10;
  var dimensions = [
      {
        prop: "FTAFTPS100",
        preUnit: "",
        postUnit: "",
        fmt: fmtP,
        divide: 100,
        title: "DL. Suspension Rate",
        inverse: false,
        gamma: 0.15, //0.40, //0.70,
        opacity: 0.75, //0.85,
        invert: false,
        color: "darkred"//,
        //dist: d3.range(bins)
      },
      {
        prop: "povrate",
        preUnit: "",
        postUnit: "",
        fmt: fmtP,
        divide: 100,
        title: "Poverty Rate",
        inverse: false,
        gamma: 0.15, //0.50,
        opacity: 0.80,
        invert: false,
        color: "mediumblue"
      },
/*
      {
        prop: "IncK",
        preUnit: "$",
        postUnit: "K",
        fmt: fmt,
        divide: 1,
        title: "Average Income (inverted)",
        inverse: true,
        gamma: 0.18, //0.50,
        opacity: 0.80,
        invert: false,
        color: "darkgreen"
      },
*/
      {
        prop: "Black",
        preUnit: "",
        postUnit: "",
        fmt: fmtP,
        divide: 100,
        title: "African American %",
        inverse: false,
        gamma: 0.15, //.50,
        opacity: 0.80,
        invert: false,
        color: "purple"
      },
      {
        prop: "Hisp",
        preUnit: "",
        postUnit: "",
        fmt: fmtP,
        divide: 100,
        title: "Latino %",
        inverse: false,
        gamma: 0.15, //0.50,
        opacity: 0.80,
        invert: false,
        color: "teal"
      },
      {
        prop: "Asian",
        preUnit: "",
        postUnit: "",
        fmt: fmtP,
        divide: 100,
        title: "Asian %",
        inverse: false,
        gamma: 0.15, //0.50,
        opacity: 0.80,
        invert: false,
        color: "indianred"
      },
      {
        prop: "WhiteNH",
        preUnit: "",
        postUnit: "",
        fmt: fmtP,
        divide: 100,
        title: "White (Non-Latino) %",
        inverse: false,
        gamma: 0.15, //0.50,
        opacity: 0.80,
        invert: false,
        color: "dimgray"
      }
    ];

  // process dimensions
  dimensions.forEach(function(dim) {

    // get range
    var range = d3.extent(zipcodes.features, function(d, i) {
      return d.properties[dim.prop];
    })
    dim.range = range;
    //console.log("range", range)

    // get values
    var values = zipcodes.features
        .map(function(d) { return d.properties[dim.prop] })
        .sort(function(a, b) { return a - b; })

    // get distribution
    if (!dim.dist) {
      var dist = d3.range(bins).map(function(d) {
        return d3.quantile(values, d / bins);
      })
      dim.dist = dist;
    }

    // generate filters
    var layerFilters = [];
    for (var p = 0; p < bins; p++) {
      var filters;
      if (p < bins - 1) {
        filters = [ 'all',
          [ '>=', dim.prop, dim.dist[p] ],
          [ '<', dim.prop, dim.dist[p + 1] ]
        ]
      } 
      else {
        filters = [ 'all',
          [ '>=', dim.prop, dim.dist[p] ]
        ]
      }
      layerFilters.push(filters);
    }
    dim.filters = layerFilters;
  })
  d3.select("#message").text("Processed data dimensions...")
  //console.log(JSON.stringify(dimensions, null, 1))


  function calcGamma(val, gamma) {
    return Math.pow(val, (1 / gamma));
  }


  function initMap(container, prop, color, gamma, opacity, levels, filters, title, dims) {

    d3.select("#message").text("Initializing map in container: " + container + "...")
/*
    console.log("container", container)
    console.log("prop", prop)
    console.log("color", color)
    console.log("gamma", gamma)
    console.log("opacity", opacity)
    console.log("levels", levels)
    console.log("filters", filters)
    console.log("title", title)
    console.log("dims", dims)
*/

    var dataLayers = [];
    
    for (var p = 0; p < bins; p++) {

      // add the layer and filters to the dataLayers array
      dataLayers.push({
        id: "dataLayer" + p,
        interactive: true,
        type: 'fill',
        source: 'zipcodes', 
        paint: {
          'fill-color': color,
          'fill-opacity': calcGamma((p + 1) / bins, gamma) * opacity
        },
        filter: filters[p]
      })
    }

    var layers = [];
    layerStack0.forEach(function(d) { layers.push(d) })
    dataLayers.forEach(function(d)   { layers.push(d) })
    layerStack2.forEach(function(d) { layers.push(d) })

    // init the map
    d3.select("#message").text("Creating map...")

    // orig
    /*
    var map = new mapboxgl.Map({
        container: container,
        maxZoom: 14, //13 
        minZoom: 4,
        zoom: 6,
        center: [-119, 37],
        style: 'mapbox://styles/mapbox/bright-v8',
        hash: false
    });
    */

    // new SF based initial view
    //{ name: "SF Bay Area", location: [-122.35, 37.78], zoom: 10.0, bearing: 0, speed: 1, curve: 1 },
    var map = new mapboxgl.Map({
        container: container,
        maxZoom: 14, //13 
        minZoom: 4,
        zoom: 10,
        center: [-122.35, 37.78],
        style: 'mapbox://styles/mapbox/bright-v8',
        hash: false
    });
    d3.select("#message").text("Created map...")


    // add controls to the map, and event handler
    map.addControl(new mapboxgl.Navigation());
    d3.selectAll(".mapboxgl-ctrl-compass").on("click", function() {
      d3.select("#tiltSlider").property("value", 0)
    })

    map.on("load", function() {
      //console.log("load...")
      loader.className = 'done';
      setTimeout(function() {
        loader.className = 'hide';
      }, 500);

      d3.select("#main").style("display", "block");
      setWindowSize();

      d3.select("#map2DataSelect").style("display", "block");
      d3.selectAll(".legend").style("display", "block")
    })

    // load the counties and zipcode layers at style.load event
    map.on("style.load", function() {
      //console.log("style.load...")
      d3.select("#message").text("Adding data layers...")

      // add the two data sources before adding the layers
      // note: extreme performance penalty if adding the data source repeatedly for each layer
      map.addSource("counties", {
          "type": "geojson",
          "data": counties
      });

      map.addSource("zipcodes", {
          "type": "geojson",
          "data": zipcodes
      });

      // add the zip code layers
      layers.forEach(function(d, i) {
        d3.select("#message").text("Adding layer: " + i + "...")
        //console.log("--Adding layer", d, i)
        map.addLayer(d)
      })

      d3.select("#message").text("Loading map layers â€“ Done");
    })

    var cursorTrackerDiv = d3.select("#" + container)
      .append("div")
        .attr("id", container + "TrackerDiv")
        .attr("class", "trackerDiv")
        .style("position", "absolute")
        .style("top", "0px")
        .style("left", "0px");

    var cursorTracker = cursorTrackerDiv
      .append("div")
        .attr("id", container + "Tracker")
        .attr("class", "tracker")
        .style("position", "absolute")
        .style("top", "-40px")
        .style("left", "-40px")
        .style("width", "7px")
        .style("height", "7px")
        .style("background-color", "black")
        .style("border-radius", "50%")

    // remove zip code area border when zoomed out
    map.on('zoom', function() {
        var layer = map.getLayer("zipcodesLine");
        var zoom = map.getZoom();
        if (zoom < 9) map.setPaintProperty("zipcodesLine", "line-width", 0)
        else map.setPaintProperty("zipcodesLine", "line-width", 0.5);
    });

    // update the overlay
    map.on('mousemove', function(e) { mouseMove(container, e) }) 

    // create title elem above the map
    var titleDiv = d3.select("#" + container)
      .append("div")
        .attr("id", container + "Title")
        .attr("class", "headerBox")

    titleDiv.append("h2")
        .attr("class", "header")
        .text(title);

    // create the legend div and svg (actual svg contents will be set later)
    var legendDiv = d3.select("#" + container)
        .append("div")
          .attr("id", container + "Legend")
          .attr("class", "legend")
          .style("right", function(d) { return container == "map2" ? null : "20px" })
          .style("left", function(d) { return container == "map2" ? "20px" : null; })

    legendDiv.append("label")
        .style("margin-left", (legendMarginLeft - 3) + "px")
        .text("Legend")

    var svg = legendDiv.append("svg")
        .attr("width", legendSvgWidth)
        .attr("height", legendSvgHeight)
        .attr("id", container + "LegendSvg")
        .append("g");

    // if dimensions array is passed in, then select elem to allow choice of data series
    if (dims) {
      var dataSelectDiv = d3.select("#" + container)
        .append("div")
          .attr("id", container + "DataSelect")
          .attr("class", "dataSelect")
          .style("right", function(d) { return container == "map2" ? "20px" : null; })
          .style("left", function(d) { return container == "map2" ? null : "20px" })

      dataSelectDiv.append("label")
          .text("Select data series")

      dataSelectDiv.append("select")
          .on("change", function() {
            var elem = d3.select(this)
            var value = elem.property("value")
            dims.slice(1).some(function(d, i) {
              if (d.prop == value) {
                setDimension(i + 1);
                return true;
              }
            })
          })
          .selectAll("option")
          .data(dims.slice(1))
        .enter().append("option")
          .attr("value", function(d) { return d.prop })
          .text(function(d) { return d.title })
      
      // is there a querystring showSettings parameter?
      var query = window.location.search;
      var display = "none";
      if (query.indexOf("showSettings=true") != -1) display = "block";

      var rangeDiv = dataSelectDiv.append("div")
          .style("display", display)

      var span = rangeDiv.append("span")
          .style("display", "block")
          .style("margin-top", "20px")

      span.append("label")
          .style("display", "block")
          .text("Contrast")

      span.append("input")
          .attr("id", "contrastRange")
          .attr("min", 0)
          .attr("max", 100)
          .attr("step", 1)
          .attr("value", 100)
          .attr("type", "range")
          .style("width", "200px")
          .on("change", function() { rangeContrastEvent.call(this) })
          .on("input", function() { rangeContrastEvent.call(this) })

      span.append("p")
          .attr("id", "contrastText")
          .style("margin-top", "0px")
          .text("value");

      span = rangeDiv.append("span")
          .style("display", display)
          .style("margin-top", "20px")

      span.append("label")
          .style("display", "block")
          .text("Opacity");

      span.append("input")
          .attr("id", "opacityRange")
          .attr("min", 0)
          .attr("max", 100)
          .attr("step", 1)
          .attr("value", 100)
          .attr("type", "range")
          .style("width", "200px")
          .on("change", function() { rangeOpacityEvent.call(this) })
          .on("input", function() { rangeOpacityEvent.call(this) })

      span.append("p")
          .attr("id", "opacityText")
          .style("margin-top", "0px")
          .text("value");


      // create quick move select
      dataSelectDiv.append("label")
        .style("display", "block")
        .style("margin-top", "15px")
        .text("Quick move")

      var flyToSelect = dataSelectDiv.append("select")
          .style("margin-bottom", "10px")
          .on("change", function() {
            var elem = d3.select(this);
            var value = elem.property("value");
            //console.log(value)
            flyTo(targets[+value]);
          });

      var options = flyToSelect.selectAll("option")
          .data(targets)
        .enter().append("option")
          .property("value", function(d, i) { return i; })
          .text(function(d) { return d.name; })

      // create contrast radio buttons
      var contrastData = [{ label: "High", value: 15, checked: true }, { label: "Medium", value: 40, checked: false }, { label: "Low", value: 80, checked: false }]
      var contrastRadio = dataSelectDiv.append("div")
      contrastRadio.append("legend")
          .style("font-weight", "bold")
          .style("padding", "0px")
          .style("margin-top", "5px")
          .text("Contrast");

      contrastRadio.selectAll(".contrastRadioBtn")
          .data(contrastData)
        .enter().append("label")
          .text(function(d) { return d.label; })
          .style("font-weight", "normal")
        .append("input")
          .attr("type", "radio")
          .attr("name", "contrast")
          .attr("value", function(d) { return d.value; })
          .property("checked", function(d) { return d.checked })
          .style("margin-right", "10px")
          .text(function(d) { return d.value; })
          .on("change", function() {
            var value = d3.select("input[name=contrast]:checked").property("value")
            //console.log("value", value)
            currGamma = value / 100;
            var dim = getDimension();
            setDimension(dim);
            updateMainContrast();
          })
    }

    function rangeContrastEvent() {
      var elem = d3.select(this)
      var value = elem.property("value")
      //console.log("value", value)
      d3.select("#contrastText").text(fmt(value));

      var dim = getDimension();
      setDimension(dim, value / 100)
    }


    function rangeOpacityEvent() {
      var elem = d3.select(this)
      var value = elem.property("value")
      d3.select("#opacityText").text(value);

      var dim = getDimension();
      var d = dimensions[dim];
      d.opacity = value / 100;

      setDimension(dim, d.gamma, d.opacity, d.color)
    }

    // return the map to caller
    return map;
  }
  // end initMap


  function fly(idx) {
    flyTo(targets[idx]);
  }


  function flyTo(target) {

      map.flyTo({
        // These options control the ending camera position: centered at
        // the target, at zoom level 9, and north up.
        center: target.location,
        zoom: target.zoom,
        bearing: target.bearing,

        // These options control the flight curve, making it move
        // slowly and zoom out almost completely before starting
        // to pan.
        speed: target.speed,
        curve: target.curve,

        // This can be any easing function: it takes a number between
        // 0 and 1 and returns another number between 0 and 1.
        easing: function (t) {
            return t;
        }
    });
  }


  // init first (left) map
  var d = dimensions[0];
  d3.select("#message").text("Initializing first map panel...")
  map = initMap("map", d.prop, d.color, d.gamma, d.opacity, d.dist, d.filters, d.title);
  updateLegend("map", d)
  //window.firstMap = map;

  // init second (right) map
  var dimensionList = dimensions.map(function(d) { return { prop: d.prop, title: d.title } }).slice(0)
  var d = dimensions[1];

  d3.select("#message").text("Initializing second map panel...")
  var map2 = initMap("map2", d.prop, d.color, d.gamma, d.opacity, d.dist, d.filters, d.title, dimensionList) 
  //window.secondMap = map;
  updateLegend("map2", d)

  d3.select("#message").text("Loading map layers...")

  d3.select("#contrastRange").property("value", d.gamma * 100);
  d3.select("#contrastText").text(fmt(d.gamma * 100));
  d3.select("#opacityRange").property("value", d.opacity * 100);
  d3.select("#opacityText").text(fmt(d.opacity * 100));


  var updateMainContrast = function() {
    var d = dimensions[0];
    d.gamma = currGamma;
    d3.range(bins).forEach(function(p) {
      var layerId = "dataLayer" + p;
      //map.setFilter(layerId, d.filters[p])
      //map.setPaintProperty(layerId, "fill-color", d.color);
      var gammaArg = d.inverse ? (bins - p + 1) / bins : (p + 1) / bins; 
      map.setPaintProperty(layerId, "fill-opacity", calcGamma(gammaArg, d.gamma) * d.opacity);
    })

    // update legend
    updateLegend("map", d)
  }


  var currDim = 1;
  var setDimension = function(dim, g, o, c) {
    var d = dimensions[dim];
    //console.log("dim", dim)
    //console.log("d", d)
    //console.log("dimensions", dimensions)
    if (g != undefined) {
      d.gamma = +g;
      currGamma = d.gamma;
    }
    if (o != undefined) d.opacity = +o
    if (c != undefined) d.color = c;
    //console.log("dataSeries:", d.prop, "gamma:", d.gamma, "opacity:", d.opacity, "color:", d.color)
    //console.log("--", map2.getLayer("dataLayer3"))
    //console.log("d", d);
    currDim = dim;
    d.gamma = currGamma;

    d3.range(bins).forEach(function(p) {
      var layerId = "dataLayer" + p;
      map2.setFilter(layerId, d.filters[p])
      map2.setPaintProperty(layerId, "fill-color", d.color);
      var gammaArg = d.inverse ? (bins - p + 1) / bins : (p + 1) / bins; 
      map2.setPaintProperty(layerId, "fill-opacity", calcGamma(gammaArg, d.gamma) * d.opacity);
    })

    d3.select("#map2Title > .header").text(d.title)

    d3.select("#contrastRange").property("value", d.gamma * 100);
    d3.select("#contrastText").text(fmt(d.gamma * 100));
    d3.select("#opacityRange").property("value", d.opacity * 100);
    d3.select("#opacityText").text(fmt(d.opacity * 100));

    // update legend
    updateLegend("map2", d)
  }

  // attach to window for debugging
  window.setDimension = setDimension;


  function getDimension() {
    return currDim;
  }


  // updates the legend with colors, opacities and threshold text
  function updateLegend(map, dim) {

    var data = d3.range(bins).map(function(e, i) {
      var obj = {};
      obj.color = dim.color;
      var gammaArg = dim.inverse ? (bins - i + 1) / bins : (i + 1) / bins; 
      var gammaArg = (i + 1) / bins; 
      obj.opacity = calcGamma(gammaArg, dim.gamma) * dim.opacity;
      obj.value = dim.dist[i];
      obj.preUnit = dim.preUnit;
      obj.postUnit = dim.postUnit;
      obj.fmt = dim.fmt;
      obj.divide = dim.divide;
      obj.inverse = dim.inverse;
      return obj;
    })

    var tickData = data.slice();
    tickData.push({ last: true, value: dim.range[1], preUnit: dim.preUnit, postUnit: dim.postUnit, fmt: dim.fmt, divide: dim.divide, inverse: dim.inverse })
    if (dim.inverse) tickData.reverse();

    var svg = d3.select("#" + map + "LegendSvg").select("g")

    // append opaque background
    svg.selectAll(".backgroundRect")
        .data([{ width: legendElemWidth, height: legendElemHeight * bins, x: legendMarginLeft, y: legendMarginTop, color: "white", opacity: 1 }])
      .enter().append("rect")
        .attr("class", "backgroundRect")
        .style("width", function(d) { return d.width; })
        .style("height", function(d) { return d.height; })
        .style("x", function(d) { return d.x + "px"; })
        .style("y", function(d) { return d.y + "px"; }) 
        .style("fill", function(d) { return d.color; }) 
        .style("opacity", function(d) { return d.opacity; }) 
  
    var boxes = svg.selectAll(".foregroundRect")
        .data(data)

    boxes
      .enter().append("rect")
        .attr("class", "foregroundRect")
        .style("width", legendElemWidth)
        .style("height", legendElemHeight)
        .style("x", legendMarginLeft + "px")
        .style("y", function(d, i) { 
          return legendMarginTop + i * legendElemHeight
        })
        .style("stroke", "gray")

    boxes
        .style("fill", function(d) {
          return d.color;
        })
        .style("opacity", function(d) {
          return d.opacity + 0.0001;
        });


    var ticks = svg.selectAll(".leftTick")
        .data(tickData)
      .enter().append("line")
        .attr("class", "leftTick")
        .attr("x1", legendMarginLeft - 5)
        .attr("x2", legendMarginLeft + legendElemWidth + 5)
        .attr("y1", function(d, i) {
          return legendMarginTop + i * legendElemHeight
        })
        .attr("y2", function(d, i) {
          return legendMarginTop + i * legendElemHeight
        })
        .style("stroke", "gray")

    var leftScale = svg.selectAll(".leftScale")
        .data(tickData)
      .enter().append("text")
        .attr("class", "leftScale")
        .attr("x", legendMarginLeft - 6)
        .attr("y", function(d, i) {
          return legendMarginTop + 3 + i * legendElemHeight
        })
        .text(function(d, i) {
          //return dim.inverse ? (bins - i) * 10 + "%" : i * 10 + "%";
          //return i * 10 + "%";
          //return (bins - i) / bins * 100 + "%" 
          return i / bins * 100 + "%" 
        })
        .attr("text-anchor", "end")
        .style("font-size", "10px")

    var rightScale = svg.selectAll(".rightScale")
      .data(tickData)

    rightScale
    .enter().append("text")
      .attr("class", "rightScale")

    rightScale
      .attr("x", legendMarginLeft + legendElemWidth + 6)
      .attr("y", function(d, i) {
        return legendMarginTop + 3 + i * legendElemHeight
      })
      .text(function(d, i) {
        return d.preUnit + d.fmt(d.value  / d.divide) + d.postUnit;
      })
      .attr("text-anchor", "start")
      .style("font-size", "10px")

    svg.selectAll(".leftLegendTitle")
        .data([{ text: "Percentiles", rotate: "270" }])
      .enter().append("text")
        .attr("class", "leftLegendTitle")
        .style("text-anchor", "middle")
        .attr("transform", "rotate(270)")
        .attr("x", function() {
          return -legendSvgHeight / 2;
        })
        .attr("y", 12)
        .style("font-weight", "bold")
        .text("Percentiles");

    svg.selectAll(".rightLegendTitle")
        .data([{ text: "Thresholds", rotate: "90" }])
      .enter().append("text")
        .attr("class", "rightLegendTitle")
        .style("text-anchor", "middle")
        .attr("transform", "rotate(90)")
        .attr("x", function() {
          return legendSvgHeight / 2;
        })
        .attr("y", -115)
        .style("font-weight", "bold")
        .text("Thresholds");

    svg.selectAll(".percentileTracker")
        .data([{ radius: 4, percentile: 3 }])
      .enter().append("circle")
        .attr("class", "percentileTracker")
        .attr("cx", (legendMarginLeft + legendElemWidth / 2))
        .attr("cy", function(d) { return d.percentile * legendElemHeight + 1 })
        .attr("r", function(d) { return d.radius })
        .style("fill", "black")
  }



  function updatePercentileMarker(zipCode) {
    var idx = -1;
    var idx2 = -1;
    var inverse = false;
    var inverse2 = false;

    if (zipCode == "") {
      //console.log("remove")
    } else {
      var data = zipData[zipCode];
      if (data) {

        // handle map (dim 0)
        var dim = dimensions[0];
        var value = data[dim.prop]
        var dist = dim.dist;
        dist.some(function(d) {
          if (d > value) return true;
          idx++;
        })
        inverse = dim.inverse;

        // handle map2
        dim = dimensions[getDimension()];
        value = data[dim.prop]
        dist = dim.dist;
        dist.some(function(d) {
          if (d > value) return true;
          idx2++;
        })
        inverse2 = dim.inverse;
        //console.log("percentile2: " + idx2)
      }
    }

    // set the marker
    setPercentileMarker("map", idx, inverse)
    setPercentileMarker("map2", idx2, inverse2)
  }


  function setPercentileMarker(map, percentile, inverse) {
    var pos = percentile == -1 ? -100 : inverse ? (bins - percentile) * legendElemHeight : (percentile + 1) * legendElemHeight
    d3.select("#" + map + "LegendSvg").select("g").select(".percentileTracker")
        .attr("cy", function() {
          return pos
        })
  }

  // init percentile markers
  setPercentileMarker("map", -1, false);
  setPercentileMarker("map2", -1, false);




  var disable = false;
  map.on("move", function() {
    if (!disable) {
      var center = map.getCenter();
      var zoom = map.getZoom();
      var pitch = map.getPitch();
      var bearing = map.getBearing(); 
      //console.log(center, zoom, pitch, bearing)

      disable = true;
      map2.setCenter(center);
      map2.setZoom(zoom);
      map2.setPitch(pitch);
      map2.setBearing(bearing);
      disable = false;     
    }
  })


  map2.on("move", function() {
    if (!disable) {
      var center = map2.getCenter();
      var zoom = map2.getZoom();
      var pitch = map2.getPitch();
      var bearing = map2.getBearing();

      disable = true;
      map.setCenter(center);
      map.setZoom(zoom);
      map.setPitch(pitch);
      map.setBearing(bearing);
      disable = false;     
    }
  })


  map.on("drag", function(e) {
    //console.log("drag -----------e", e)
  })
  map.on("dragend", function(e) {
    //console.log("dragend -----------e", e)
  })
  map.on("dragstart", function(e) {
    //console.log("dragstart -----------e", e)
  })


  // map pitch handlers
  d3.select("#tiltSlider").on("change", function() { tiltSlider.call(this) });
  d3.select("#tiltSlider").on("input",  function() { tiltSlider.call(this) });
  function tiltSlider() {
    var elem = d3.select(this)
    var value = +elem.property("value");
    map.setPitch(value)
  }


  // manages the side panel
  function manageSidePanel(data) {
    var controls = d3.select("#controls");
    
    // remove current elements
    controls.selectAll("p").remove();
    
    // add new p elements
    controls.selectAll("p")
        .data(data)
      .enter().append("p")
        .html(function(d) { return d; })

    setOverlayPos();
  }


  // establish handler for the "how to use" div
  d3.select("#howToUse").on("click", function() {
    var state = d3.select("#instructions").style("display");
    if (state == "none") state = "block";
    else state = "none";
    d3.select("#instructions").style("display", state);
    d3.select(this).text(function() {
      return state == "none" ? "How to use..." : "How to use (close)";
    })

    setOverlayPos();
  })

  // handler for "sources" div
  d3.select("#sourcesTitle").on("click", function() {
    var state = d3.select("#sources").style("display");
    if (state == "none") state = "block";
    else state = "none";
    d3.select("#sources").style("display", state);
    d3.select(this).text(function() {
      return state == "none" ? "About..." : "About (close)";
    })

    setOverlayPos();
  })  


  function mouseMove (container, e) {
    var fmtPct = d3.format(",.1%");
    var fmtInt = d3.format(",d");
    var fmtFloat = d3.format(".1f");

    //console.log("container", container);
    var t = container == "map" ? { tracker: "map2", noTracker: "map" } : { tracker: "map", noTracker: "map2" };
    d3.select("#" + t.tracker + "Tracker").style("left", e.point.x + "px").style("top", e.point.y + "px");
    d3.select("#" + t.noTracker + "Tracker").style("left", "-40px").style("top", "-40px")    
    
    map.featuresAt(e.point, {radius: 5}, function (error, features) {
      if (error) throw error;
      if (features.length == 0) return;

      // separate county and zip code entries in the features array
      var countyInfo = features.filter(function(d) { if (d.properties.ALAND != undefined) return true });
      var zipInfo = features.filter(function(d) { if (d.properties.City != undefined) return true });

      // clear properties
      var item = {
        County: "",
        ZipCode: "",
        Places: "",
        FTAFTPS100: "",
        City: "",
        povrate: "",
        Pop15Plus: "",
        IncK: "",
        Black: "",
        Hisp: "",
        Asian: "",
        White: "",
      };

      // obtain county name from first item in county array
      if (countyInfo.length > 0) {
        item.County = countyInfo[0].properties.NAME
      }

      // obtain zip code info from first item in zip code array
      if (zipInfo.length > 0) {
        item.ZipCode =    zipInfo[0].properties.zip;
        item.Places =     zipInfo[0].properties.Places;
        item.FTAFTPS100 = zipInfo[0].properties.FTAFTPS100;
        item.City =       zipInfo[0].properties.City;
        item.povrate =    zipInfo[0].properties.povrate;
        item.Pop15Plus =  zipInfo[0].properties.Pop15Plus;
        item.IncK =       zipInfo[0].properties.IncK;
        item.Black =      zipInfo[0].properties.Black;
        item.Hisp =       zipInfo[0].properties.Hisp;
        item.Asian =      zipInfo[0].properties.Asian;
        item.White =      zipInfo[0].properties.WhiteNH;
      }

      // set the text in the overlay panel
      /*
      var text = [
        "Zip Code: <b>" + item.ZipCode + "</b>",
        "Place: <b>" + item.Places + "</b>",
        "County: <b>" + item.County + "</b>",
        "Suspensions: <b>" + fmtPct(item.FTAFTPS100 / 100) + "</b>",
        "Poverty Rate: <b>" + fmtPct(item.povrate / 100) + "</b>",
        "Population 15y+: <b>" + fmtInt(item.Pop15Plus) + "</b>",
        "Avg Income: <b>" + fmtFloat("" + item.IncK) + "K</b>",
        "Black: <b>" + fmtPct("" + item.Black / 100) + "</b>",
        "Hispanic: <b>" + fmtPct("" + item.Hisp / 100) + "</b>",
        "Asian: <b>" + fmtPct("" + item.Asian / 100) + "</b>",
        "White: <b>" + fmtPct("" + item.White / 100) + "</b>"
      ];
      */
      //console.log("item", item)
      var text = [
        "<b>Location: </b>" +
            " <b>" + item.Places + "</b>" +
            " Zip: " + item.ZipCode + 
            " (" + item.County + " County)",
        "<b>DL. Suspension Rate: " + fmtPct(item.FTAFTPS100 / 100) + "</b>",
        "<b>Poverty Rate: " + fmtPct(item.povrate / 100) + "</b>",
        "<b>Population 15y+: " + fmtInt(item.Pop15Plus) + "</b>",
        "<b>Avg Income: $" + fmtFloat("" + item.IncK) + "K</b>",
        "<b>Racial composition: </b>" + 
            " Black: " + fmtPct("" + item.Black / 100) + 
            " Lat: " +  fmtPct("" + item.Hisp  / 100) + 
            " Asian: " + fmtPct("" + item.Asian / 100) +
            " White: " + fmtPct("" + item.White / 100)
      ];

      // update panel
      manageSidePanel(text);

      // update percentile marker
      updatePercentileMarker(item.ZipCode);

    });
  };

}

</script>

